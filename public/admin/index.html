<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 0;
      margin: 0;
    }
    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f8f9fa;
    }
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #2E86AB;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    .loading-text {
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
    }
    .debug-info {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f5f5f5;
      max-width: 80%;
      overflow: auto;
      font-size: 14px;
    }
    .error-message {
      margin-top: 20px;
      padding: 10px;
      color: white;
      background-color: #dc3545;
      border-radius: 4px;
      max-width: 80%;
    }
    .retry-button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .retry-button:hover {
      background-color: #0069d9;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Loading indicator -->
  <div class="loader-container" id="loading">
    <div class="loader"></div>
    <div class="loading-text">Loading Content Management System...</div>
    <div id="loading-status">Initializing CMS...</div>
    <div class="debug-info" id="debug-info"></div>
    <div class="error-message" id="error-message" style="display: none;"></div>
    <button class="retry-button" id="retry-button" style="display: none;" onclick="window.location.reload()">Retry</button>
  </div>

  <!-- Decap CMS will mount here -->
  <div id="nc-root"></div> 

  <!-- Load Decap CMS script -->
  <script>
    // Debug helper
    function logDebug(message) {
      const debugInfo = document.getElementById('debug-info');
      const loadingStatus = document.getElementById('loading-status');
      
      if (debugInfo) {
        debugInfo.innerHTML += message + '<br>';
      }
      
      if (loadingStatus) {
        loadingStatus.textContent = message;
      }
      
      console.log(message);
    }

    // Handle errors
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      const retryButton = document.getElementById('retry-button');
      
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
      
      if (retryButton) {
        retryButton.style.display = 'block';
      }
      
      logDebug('ERROR: ' + message);
    }

    // Initialize with fallback timeout
    let initTimeout = setTimeout(function() {
      showError('CMS initialization timed out. This may be due to an authentication issue or network problem.');
    }, 30000); // 30 second timeout

    // Define config before loading CMS
    window.CMS_MANUAL_INIT = true;
    window.CMS_CONFIGURATION = {
      backend: {
        name: 'github',
        repo: 'johnnyhawk02/livpac-website',
        branch: 'main',
        base_url: 'https://livpac.pages.dev',
        auth_endpoint: '/api/auth',
        site_domain: 'livpac.pages.dev'
      },
      media_folder: 'public/uploads/images',
      public_folder: '/uploads/images',
      publish_mode: 'editorial_workflow',
      collections: [
        {
          name: 'news',
          label: 'News Posts',
          folder: 'src/content/news',
          create: true,
          slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
          extension: 'md',
          format: 'frontmatter',
          fields: [
            { label: 'Title', name: 'title', widget: 'string' },
            { label: 'Publication Date', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD', date_format: 'YYYY-MM-DD', time_format: false },
            { label: 'Body', name: 'body', widget: 'markdown' },
            { label: 'Featured Image', name: 'image', widget: 'image', required: false }
          ]
        }
      ]
    };
  </script>

  <!-- Load Decap CMS script -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // Start monitoring for errors
    window.addEventListener('error', function(event) {
      showError('JavaScript error: ' + event.message);
    });

    logDebug('Page loaded, waiting for CMS...');
    
    // Initialize CMS once loaded
    document.addEventListener('DOMContentLoaded', function() {
      if (window.CMS) {
        logDebug('CMS object found, initializing manually...');
        try {
          // Register the init event before initialization
          window.CMS.registerEventListener({
            name: 'init',
            handler: () => {
              logDebug('CMS initialized successfully!');
              clearTimeout(initTimeout);
              document.getElementById('loading').style.display = 'none';
            },
          });
          
          // Initialize with configuration
          window.CMS.init({ config: window.CMS_CONFIGURATION });
          logDebug('CMS.init() called');
          
        } catch (error) {
          showError('CMS initialization error: ' + error.message);
        }
      } else {
        logDebug('WARNING: CMS object not found after DOMContentLoaded');
        
        // Check again after a short delay
        setTimeout(function() {
          if (window.CMS) {
            logDebug('CMS found after delay, attempting initialization...');
            try {
              window.CMS.registerEventListener({
                name: 'init',
                handler: () => {
                  logDebug('CMS initialized successfully (delayed)!');
                  clearTimeout(initTimeout);
                  document.getElementById('loading').style.display = 'none';
                },
              });
              
              window.CMS.init({ config: window.CMS_CONFIGURATION });
            } catch (error) {
              showError('Delayed CMS initialization error: ' + error.message);
            }
          } else {
            showError('CMS object not available - script may have failed to load');
          }
        }, 2000);
      }
    });
  </script>
</body>
</html> 